name: App CI/CD (Docker -> YCR -> K8s)

on:
  push:
    branches: [ "master" ]
    paths:
      - "terraform/app/**"
      - ".github/workflows/app.yml"
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: cr.yandex
      REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
      IMAGE_NAME: ${{ secrets.YC_IMAGE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install YC CLI (no sudo)
        run: |
          mkdir -p "$HOME/bin"
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/release/latest/linux/amd64/yc -o "$HOME/bin/yc"
          chmod +x "$HOME/bin/yc"
          echo "$HOME/bin" >> $GITHUB_PATH
          export PATH="$HOME/bin:$PATH"
          yc --version

      - name: Configure YC CLI (Service Account)
        run: |
          echo '${{ secrets.YC_SA_KEY }}' > key.json
          yc config set service-account-key key.json

      - name: Get IAM token and Docker login to YCR
        run: |
          IAM_TOKEN=$(yc iam create-token)
          echo "$IAM_TOKEN" | docker login -u oauth --password-stdin $REGISTRY

      - name: Build & Push (latest on commit)
        if: github.ref_type != 'tag'
        working-directory: terraform/app
        run: |
          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:latest"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Build & Push (versioned on tag)
        if: github.ref_type == 'tag'
        working-directory: terraform/app
        run: |
          TAG="${GITHUB_REF_NAME}"
          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:$TAG"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > ~/.kube/config
          kubectl version --client
          kubectl get ns

      - name: Deploy new image to Kubernetes
        run: |
          REGISTRY="cr.yandex"
          REGISTRY_ID="${{ secrets.YC_REGISTRY_ID }}"
          IMAGE_NAME="${{ secrets.YC_IMAGE_NAME }}"
          TAG="${GITHUB_REF_NAME}"

          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:$TAG"

          kubectl -n app set image deployment/netology-nginx nginx="$IMAGE"
          kubectl -n app rollout status deployment/netology-nginx --timeout=180s
