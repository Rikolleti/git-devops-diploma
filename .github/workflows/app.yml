name: App CI/CD (Docker -> YCR -> K8s)

on:
  push:
    branches: ["master"]
    paths:
      - "terraform/app/**"
      - ".github/workflows/app.yml"
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: cr.yandex
      REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
      IMAGE_NAME: ${{ secrets.YC_IMAGE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install YC CLI (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i "$HOME/yandex-cloud" -n
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"

      - name: Configure YC CLI (Service Account)
        shell: bash
        run: |
          set -euo pipefail
          cat > key.json << 'EOF'
          ${{ secrets.YC_SA_KEY }}
          EOF
          yc config set service-account-key key.json
          yc --version

      - name: Docker login to YCR
        shell: bash
        run: |
          set -euo pipefail
          IAM_TOKEN="$(yc iam create-token)"
          echo "$IAM_TOKEN" | docker login -u iam --password-stdin "$REGISTRY"

      - name: Build & Push (latest on commit)
        if: github.ref_type != 'tag'
        working-directory: terraform/app
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:latest"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Build & Push (versioned on tag)
        if: github.ref_type == 'tag'
        working-directory: terraform/app
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:$TAG"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y kubectl
          kubectl version --client

      - name: Install & Configure YC CLI (needed by kubeconfig exec)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i "$HOME/yandex-cloud" -n
          echo "$HOME/yandex-cloud/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          cat > key.json << 'EOF'
          ${{ secrets.YC_SA_KEY }}
          EOF
          yc config set service-account-key key.json

          yc --version
          yc config list || true

      - name: Setup kubeconfig and verify access
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > ~/.kube/config

          kubectl get ns

      - name: Deploy new image to Kubernetes
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/yandex-cloud/bin:$PATH"

          REGISTRY="cr.yandex"
          REGISTRY_ID="${{ secrets.YC_REGISTRY_ID }}"
          IMAGE_NAME="${{ secrets.YC_IMAGE_NAME }}"
          TAG="${GITHUB_REF_NAME}"
          IMAGE="$REGISTRY/$REGISTRY_ID/$IMAGE_NAME:$TAG"

          kubectl -n app set image deployment/netology-nginx nginx="$IMAGE"
          kubectl -n app rollout status deployment/netology-nginx --timeout=180s
